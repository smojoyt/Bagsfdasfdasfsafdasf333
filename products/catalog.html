<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Karry Kraze - Catalog</title>

    <!-- ✅ Meta Description -->
    <meta name="description" content="Shop Karry Kraze for stylish, standout bags and fashion accessories. Free U.S. shipping over $50!" />

    <!-- ✅ Favicon -->
    <link rel="icon" href="/imgs/Logo/Short/SL_White_01.png" type="image/png" />

    <!-- ✅ Social Media Meta -->
    <meta property="og:title" content="Karry Kraze – Unique Bags & Accessories" />
    <meta property="og:description" content="Shop Karry Kraze for stylish, standout bags and fashion accessories. Free U.S. shipping over $50!" />
    <meta property="og:image" content="https://www.karrykraze.com/imgs/Logo/Short/801.jpg" />
    <meta property="og:url" content="https://www.karrykraze.com/" />
    <meta property="og:type" content="website" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Karry Kraze – Unique Bags & Accessories" />
    <meta name="twitter:description" content="Shop Karry Kraze for stylish, standout bags and fashion accessories. Free U.S. shipping over $50!" />
    <meta name="twitter:image" content="https://www.karrykraze.com/imgs/Logo/Short/801.jpg" />

    <!-- ✅ TailwindCSS (DEV ONLY) -->
    <!-- ⚠️ Use Tailwind via PostCSS or CDN build for production to avoid performance issues -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ✅ Stylesheets -->
    <link rel="stylesheet" href="https://unpkg.com/flickity@2/dist/flickity.min.css" />

    <!-- ✅ Scripts (3rd-party, defer if not needed immediately) -->
    <script defer src="https://unpkg.com/isotope-layout@3/dist/isotope.pkgd.min.js"></script>
    <script defer src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
    <script defer src="https://unpkg.com/flickity@2/dist/flickity.pkgd.min.js"></script>

    <!-- ✅ Your Scripts (defer to load after HTML parsing) -->
    <script defer src="/js/helpers.js"></script>
    <script defer src="/js/cartUtils.js"></script>
    <script defer src="/js/bundleEngine.js"></script>
    <script defer src="/js/cartRenderer.js"></script>
    <script defer src="/js/checkout.js"></script>
    <script defer src="/js/uni_navbar.js"></script>
    <script defer src="/js/moreItemsCarousel.js"></script>
    <script defer src="/js/loadProductData.js"></script>

    <!-- ✅ Custom Styles -->
    <style>
        .item {
            width: 45% !important;
        }

        @media (min-width: 768px) {
            .item {
                width: 31.3333% !important;
            }
        }

        @media (min-width: 1024px) {
            .item {
                width: auto !important;
            }
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>

<body class="bg-[#ffeddf] text-gray-900">
    <!-- 🔥 Dynamic Banner Section -->
    <div class="relative w-full pt-16 overflow-hidden">
        <img id="catalog-banner" src="" alt="Catalog Banner" class="w-full h-auto object-cover hidden transition-opacity duration-500">
        <div id="banner-text"
             class="absolute bottom-4 left-4 text-3xl md:text-[10rem] font-extrabold text-white drop-shadow-lg bg-black bg-opacity-40 px-3 py-1 md:px-6 md:py-2 rounded tracking-wide capitalize hidden">
            <!-- Category text appears here -->
        </div>
    </div>

    <!-- 🔲 Layout Container -->
    <div id="catalog-layout" class="flex relative transition-all duration-300 ease-in-out">

        <!-- 📂 Filter Sidebar -->
        <aside id="filter-sidebar"
               class="fixed top-16 left-0 w-[90%] sm:w-80 md:w-64 h-full bg-white border-r border-gray-200 shadow-lg z-40 transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="p-4 h-full overflow-y-auto">

                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-semibold text-lg">Filters</h2>
                    <button id="close-filters" aria-label="Close filters"
                            class="text-gray-600 hover:text-black text-xl focus:outline-none">
                        &times;
                    </button>
                </div>

                <!-- 🏷 Category Filter Group
    <div class="mb-6" data-filter-group="category">
        <h3 class="text-sm font-medium mb-2">Category</h3>
        <div class="space-y-2">
            <label class="flex items-center gap-2">
                <input type="checkbox" class="filter-checkbox" data-group="category" value=".bags" />
                <span>Bags</span>
            </label>
            <label class="flex items-center gap-2">
                <input type="checkbox" class="filter-checkbox" data-group="category" value=".headwear" />
                <span>Headwear</span>
            </label>
            <label class="flex items-center gap-2">
                <input type="checkbox" class="filter-checkbox" data-group="category" value=".charms" />
                <span>Charms</span>
            </label>
        </div>
    </div>-->
                <!-- 🧷 Tags Filter Group -->
                <div class="mb-6" data-filter-group="tags">
                    <h3 class="text-sm font-medium mb-2">Tags</h3>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" class="filter-checkbox" data-group="tags" value=".bestseller" />
                            <span>Best Sellers</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" class="filter-checkbox" data-group="tags" value=".onsale" />
                            <span>On Sale</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" class="filter-checkbox" data-group="tags" value=".instock" />
                            <span>In Stock</span>
                        </label>
                    </div>
                </div>

                <!-- 🔽 Sort Dropdown -->
                <div>
                    <label for="sort-select" class="block text-sm font-medium mb-2">Sort By</label>
                    <select id="sort-select" class="w-full border p-2 rounded focus:outline-none focus:ring focus:border-gray-400">
                        <option value="original-order">Default</option>
                        <option value="name">Name A–Z</option>
                        <option value="price-low">Price Low–High</option>
                        <option value="price-high">Price High–Low</option>
                        <option value="best-deals">Best Deals</option>
                    </select>
                </div>

                <!-- 🔘 Apply Filters Button -->
                <button id="apply-filters"
                        class="mt-4 bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded w-full focus:outline-none focus:ring">
                    Apply Filters
                </button>
            </div>
        </aside>

        <!-- 🌫 Backdrop for Mobile Sidebar -->
        <div id="filter-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>

        <!-- 🛍 Main Product Grid Section -->
        <main id="catalog-main" class="flex-1 transition-all duration-300 ease-in-out">
            <div class="flex justify-between items-center p-3 sticky top-0 z-20 bg-white border-b">
                <button id="toggle-filters"
                        class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded focus:outline-none focus:ring">
                    Filters
                </button>
            </div>

            <div class="w-full px-2 md:px-4 pb-8">
                <div class="flex flex-wrap gap-2 px-4 py-3">
                    <button class="category-btn bg-gray-800 text-white px-4 py-2 rounded" data-filter="*">All</button>
                    <button class="category-btn bg-white border border-gray-300 px-4 py-2 rounded" data-filter=".bags">Bags</button>
                    <button class="category-btn bg-white border border-gray-300 px-4 py-2 rounded" data-filter=".headwear">Headwear</button>
                    <button class="category-btn bg-white border border-gray-300 px-4 py-2 rounded" data-filter=".charms">Charms</button>
                </div>
                <div id="product-grid" class="grid gap-6 grid-cols-2 md:grid-cols-3 xl:grid-cols-4">
                    <!-- Products injected here -->
                </div>
            </div>
        </main>
    </div>

    <!-- 🔻 Footer & Navbar Inserts -->
    <div id="footer"></div>
    <div id="navbar-container"></div>


    <script>
        //  Global DOM references
        const toggleBtn = document.getElementById("toggle-filters");
        const sidebar = document.getElementById("filter-sidebar");
        const backdrop = document.getElementById("filter-backdrop");
        const closeBtn = document.getElementById("close-filters");
        const catalogMain = document.getElementById("catalog-main");

        let sidebarOpen = false;
        let filters = {};
        let iso; // Isotope instance

        // 🎯 Utility: detect mobile viewport
        const isMobile = () => window.matchMedia("(max-width: 767px)").matches;

        // 🎨 Set banner dynamically from selected category
        function setBannerFromCategory(category, products) {
            if (!category) return;

            const labelMap = {
                headwear: "Hats",
                charms: "Charms",
                bags: "Bags"
            };

            const matches = Object.values(products).filter(p =>
                p.category?.toLowerCase() === category.toLowerCase() && p.banner
            );

            if (matches.length) {
                const selected = matches[Math.floor(Math.random() * matches.length)];
                const bannerEl = document.getElementById("catalog-banner");
                const textEl = document.getElementById("banner-text");

                if (bannerEl && textEl) {
                    bannerEl.src = selected.banner;
                    bannerEl.classList.remove("hidden");
                    textEl.textContent = labelMap[category.toLowerCase()] || category;
                    textEl.classList.remove("hidden");
                }
            }
        }

        function openSidebar() {
            sidebar.classList.remove("-translate-x-full");
            sidebarOpen = true;

            if (isMobile()) {
                backdrop.classList.remove("hidden");
            } else {
                catalogMain.classList.add("ml-64");
            }

            // 🕓 Smarter layout refresh after transition
            let attempts = 0;
            const maxAttempts = 5;

            const intervalId = setInterval(() => {
                if (iso) {
                    iso.layout();
                    attempts++;
                }

                // 🔁 Stop trying after a few attempts (safety)
                if (attempts >= maxAttempts) {
                    clearInterval(intervalId);
                }
            }, 200); // 🕐 Faster interval improves responsiveness
        }

        function closeSidebar() {
            sidebar.classList.add("-translate-x-full");
            sidebarOpen = false;

            if (isMobile()) {
                backdrop.classList.add("hidden");
            } else {
                catalogMain.classList.remove("ml-64");
            }

            // 🕓 Final layout refresh after collapse
            setTimeout(() => {
                if (iso) iso.layout();
            }, 400); // Slightly more than transition
        }


        // 🧭 Sidebar event listeners
        toggleBtn?.addEventListener("click", () => sidebarOpen ? closeSidebar() : openSidebar());
        closeBtn?.addEventListener("click", closeSidebar);
        backdrop?.addEventListener("click", closeSidebar);

        // 🚀 DOM Content Loaded
        window.addEventListener("DOMContentLoaded", () => {
            const grid = document.getElementById("product-grid");
            const urlParams = new URLSearchParams(location.search);

            Promise.all([
                fetch("/products/products.json").then(r => r.json()),
                fetch("/products/promotion.json").then(r => r.json())
            ]).then(([products, promoFile]) => {
                const promos = promoFile.promotions || [];
                const catalog = applyPromotionsToProducts(products, promos);

                // 🎯 Show banner if category is in URL
                const categoryParam = urlParams.get("category");
                if (categoryParam) setBannerFromCategory(categoryParam, catalog);

                // 🧱 Render each product card
                for (const product of Object.values(catalog)) {
                    if (!product.tags?.includes("Discontinued")) {
                        grid.insertAdjacentHTML("beforeend", renderCatalogCard(product));
                    }
                }

                imagesLoaded(grid, () => {
                    iso = new Isotope(grid, {
                        itemSelector: ".item",
                        layoutMode: "fitRows",
                        sortBy: "best-deals",
                        sortAscending: false,
                        getSortData: {
                            name: "[data-name]",
                            "price-low": "[data-price] parseFloat",
                            "price-high": "[data-price] parseFloat",
                            "best-deals": "[data-discount] parseInt"
                        }
                    });

                    // 🔘 Category Button Filters
                    document.querySelectorAll(".category-btn").forEach(btn => {
                        btn.addEventListener("click", () => {
                            const filterValue = btn.getAttribute("data-filter");
                            iso?.arrange({ filter: filterValue });

                            // 🖌 Update active button styling
                            document.querySelectorAll(".category-btn").forEach(b => {
                                b.classList.remove("bg-gray-800", "text-white");
                                b.classList.add("bg-white", "text-gray-800");
                            });

                            btn.classList.remove("bg-white", "text-gray-800");
                            btn.classList.add("bg-gray-800", "text-white");
                        });
                    });

                    // ... your other filter/sort code can follow here ...
                });




                    // 🔃 Sorting
                    document.getElementById("sort-select")?.addEventListener("change", e => {
                        const sortVal = e.target.value;
                        iso.updateSortData();
                        const map = {
                            "price-high": { sortBy: "price-low", sortAscending: false },
                            "price-low": { sortBy: "price-low", sortAscending: true },
                            "best-deals": { sortBy: "best-deals", sortAscending: false }
                        };
                        iso.arrange(map[sortVal] || { sortBy: sortVal });
                    });


                });
            });
        });

        // 🌐 Reusable HTML loader
        function includeHTML(id, path, cb) {
            fetch(path).then(res => res.text()).then(html => {
                document.getElementById(id).innerHTML = html;
                cb?.();
            });
        }

        function initNavbar() {
            const toggle = document.getElementById("mobile-menu-button");
            const menu = document.getElementById("mobile-menu");
            toggle?.addEventListener("click", () => menu?.classList.toggle("hidden"));

            const cart = JSON.parse(localStorage.getItem("savedCart")) || [];
            const total = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
            const cartCounter = document.getElementById("cart-count");
            if (cartCounter) cartCounter.textContent = total;

            const navbar = document.getElementById("mainNavbar");
            let lastY = window.scrollY;
            window.addEventListener("scroll", () => {
                if (!navbar) return;
                const scrollingDown = window.scrollY > lastY && window.scrollY > 50;
                navbar.classList.replace(
                    scrollingDown ? "navbar-show" : "navbar-hide",
                    scrollingDown ? "navbar-hide" : "navbar-show"
                );
                lastY = window.scrollY;
            });
        }

        // 🔁 Main template inserts
        includeHTML("navbar-container", "/page_inserts/uni_navbar.html", () => {
            initNavbar();
            document.getElementById("add-to-cart-btn")?.addEventListener("click", () => {
                const variant = document.getElementById("variantSelector")?.value || null;
                addToCart(activeProduct, variant);
            });
            includeHTML("footer", "/page_inserts/footer.html");
        });
    </script>


</body>
</html>