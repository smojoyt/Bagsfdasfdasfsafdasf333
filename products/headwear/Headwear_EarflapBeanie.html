<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product - Karry Kraze</title>
    <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.31/default/snipcart.css" />
    <script async src="https://cdn.snipcart.com/themes/v3.0.31/default/snipcart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .navbar-hide {
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .navbar-show {
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid #f3f3f3;
            border-top: 4px solid #333;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            z-index: 9999;
        }

        @keyframes spin {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-white text-gray-800 pt-16">
    <div id="loader" class="loader"></div>
    <div id="pageContent" style="display:none;">
        <div class="max-w-4xl mx-auto px-4 py-8">
            <a href="/" class="text-blue-600 hover:underline mb-4 inline-block">&larr; Back to Shop</a>
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex-1">
                    <img id="mainImage" src="" alt="Product Image" class="w-full rounded-xl border" />
                    <div id="thumbnailContainer" class="flex gap-2 mt-4"></div>
                </div>
                <div class="flex-1">
                    <h1 id="product-name" class="text-2xl font-bold mb-2">Loading...</h1>
                    <p id="product-description" class="mb-4 text-sm"></p>
                    <p class="text-lg font-semibold">$<span id="product-price">0.00</span></p>
                    <div class="mt-4">
                        <label for="variant-select" class="block text-sm font-medium text-gray-700">Choose a Color</label>
                        <select id="variant-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                    </div>
                    <button id="add-to-cart-btn"
                            class="snipcart-add-item bg-black text-white py-2 px-4 rounded hover:bg-gray-800 transition mt-6"
                            data-item-id=""
                            data-item-name=""
                            data-item-price=""
                            data-item-url=""
                            data-item-description=""
                            data-item-image=""
                            data-item-custom1-name=""
                            data-item-custom1-options=""
                            data-item-custom1-value="">
                        Add to Cart
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="sidecart-container"></div>
    <div id="navbar-container"></div>
    <div id="unicart-container"></div>

    <div hidden id="snipcart" data-api-key="OTkwZGJhM2QtNmQyMy00ZGYxLTg4YzAtNmExNDA2MDhmNmU0NjM4NzgwMjMxMTgyOTYyMjAz"></div>

    <script>
    const skuFromURL = window.location.pathname.split("/").pop().replace(".html", "");

    function swapImage(src) {
      document.getElementById("mainImage").src = src;
    }

    function updateVariant(select) {
      const button = document.getElementById('add-to-cart-btn');
      button.setAttribute('data-item-custom1-value', select.value);
    }

    fetch("https://www.karrykraze.com/products/products.json")
      .then(res => res.json())
      .then(data => {
        const activeProduct = data[skuFromURL];
        if (!activeProduct) {
          console.error(`Product not found for SKU: ${skuFromURL}`);
          return;
        }

        document.getElementById("product-name").textContent = activeProduct.name;
        document.getElementById("product-description").textContent = Array.isArray(activeProduct.descriptionList) ? activeProduct.descriptionList.join(" | ") : activeProduct.description;
        document.getElementById("product-price").textContent = activeProduct.price.toFixed(2);

        const mainImage = document.getElementById("mainImage");
        if (mainImage && activeProduct.image) {
          mainImage.src = activeProduct.image;
        }

        const addToCartBtn = document.getElementById("add-to-cart-btn");
        addToCartBtn.dataset.itemId = skuFromURL;
        addToCartBtn.dataset.itemName = activeProduct.name;
        addToCartBtn.dataset.itemPrice = activeProduct.price;
        addToCartBtn.dataset.itemUrl = window.location.pathname;
        addToCartBtn.dataset.itemImage = activeProduct.image;
        addToCartBtn.dataset.itemDescription = Array.isArray(activeProduct.descriptionList) ? activeProduct.descriptionList.join(" | ") : activeProduct.description;

        if (activeProduct.custom1Name && activeProduct.custom1Options) {
          addToCartBtn.dataset.itemCustom1Name = activeProduct.custom1Name;
          addToCartBtn.dataset.itemCustom1Options = activeProduct.custom1Options;
        }

        const variantSelect = document.getElementById("variant-select");
        variantSelect.innerHTML = "";
        activeProduct.custom1Options.split("|").map(opt => opt.trim()).forEach(option => {
          const el = document.createElement("option");
          el.value = option;
          el.textContent = option;
          variantSelect.appendChild(el);
        });

        variantSelect.addEventListener("change", function() {
          updateVariant(this);
        });

        const thumbnailContainer = document.getElementById("thumbnailContainer");
        if (Array.isArray(activeProduct.thumbnails)) {
          thumbnailContainer.innerHTML = "";
          activeProduct.thumbnails.forEach(img => {
            const thumb = document.createElement("img");
            thumb.src = img;
            thumb.className = "w-20 h-20 object-cover rounded-lg cursor-pointer border";
            thumb.onclick = () => swapImage(img);
            thumbnailContainer.appendChild(thumb);
          });
        }

        document.getElementById('loader').style.display = 'none';
        document.getElementById('pageContent').style.display = 'block';
      });

    function includeHTML(id, filePath, callback = null) {
      fetch(filePath)
        .then(res => res.text())
        .then(html => {
          document.getElementById(id).innerHTML = html;
          if (callback) callback();
        });
    }

    includeHTML("sidecart-container", "/page_inserts/sidecart.html", () => {
      if (document.getElementById("cartItems")) renderCart();
    });
    includeHTML("navbar-container", "/page_inserts/uni_navbar.html", initNavbar);
    includeHTML("unicart-container", "/page_inserts/uni_cart.html");

    function initNavbar() {
      const toggleBtn = document.getElementById("mobile-menu-button");
      const menu = document.getElementById("mobile-menu");
      if (toggleBtn && menu) {
        toggleBtn.addEventListener("click", () => menu.classList.toggle("hidden"));
      }

      const cart = JSON.parse(localStorage.getItem("savedCart")) || [];
      const totalQty = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
      const countElem = document.getElementById("cart-count");
      if (countElem) countElem.textContent = totalQty;

      let lastScrollY = window.scrollY;
      const navbar = document.getElementById('mainNavbar');

      window.addEventListener('scroll', () => {
        if (!navbar) return;
        if (window.scrollY > lastScrollY && window.scrollY > 50) {
          navbar.classList.remove('navbar-show');
          navbar.classList.add('navbar-hide');
        } else {
          navbar.classList.remove('navbar-hide');
          navbar.classList.add('navbar-show');
        }
        lastScrollY = window.scrollY;
      });
    }
    </script>
</body>
</html>
