<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order Confirmation — Karry Kraze</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Scripts -->
    <script src="/js/helpers.js"></script>
    <script src="/js/moreItemsCarousel.js"></script>
    <script src="/js/loadProductData.js"></script>
    <script src="/js/uni_navbar.js"></script>
    <link rel="icon" href="/favicon.ico" />
    <style>
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-[#fef1e7] text-gray-800 font-sans">

    <div class="max-w-3xl mx-auto px-4 md:px-8 mt-20 mb-10 space-y-10">
        <div class="text-left">
            <h1 class="text-4xl font-extrabold text-gray-800 uppercase mb-2" id="thankYouMessage">Thank you!</h1>
            <div class="flex justify-start">
                <div class="w-24 h-1 bg-gray-300 rounded mb-6"></div>
            </div>
            <p class="text-lg text-gray-600" id="emailMessage">Processing your order...</p>
        </div>

        <div>
            <h2 class="text-2xl font-bold mb-4 border-b pb-2">Order Summary</h2>
            <div id="orderItems" class="space-y-4 text-sm">
                <p class="text-gray-500">Loading...</p>
            </div>
        </div>

        <div id="orderTotalContainer" class="pt-4 border-t hidden"></div>

        <div class="mt-16 bg-white p-4 rounded shadow text-center text-sm text-gray-600">
            With this order, you supported a Black-owned small business. We appreciate you! ❤️
        </div>

        <div class="mt-8">
            <h3 class="text-lg font-bold mb-2">Order Progress</h3>
            <div class="flex justify-between text-xs text-gray-600">
                <span>Order Placed</span>
                <span>Processing</span>
                <span>Shipped</span>
                <span>Delivered</span>
            </div>
            <div class="w-full bg-gray-200 h-1 rounded mt-2">
                <div class="w-1/4 h-1 bg-black rounded"></div>
            </div>
        </div>

        <a href="/" class="block mt-6 bg-black text-white text-center py-3 rounded hover:bg-gray-800 transition">
            Continue Shopping
        </a>

        <div class="mt-12 bg-white border border-dashed border-black p-6 rounded shadow text-center">
            <h3 class="text-2xl font-bold uppercase mb-2">Get $5 Off Your Next Order!</h3>
            <p class="text-sm text-gray-700 mb-4">Leave a review for a product you purchased and receive a $5 coupon code for your next order. It only takes a minute and helps our small business grow!</p>
            <a href="/review.html" class="inline-block bg-black text-white px-6 py-2 rounded hover:bg-gray-800 transition">Leave a Review</a>
        </div>

        <div class="mt-16">
            <h2 class="uppercase text-2xl font-bold mb-4" id="featured-title">Hot Picks</h2>
            <div class="flex justify-start">
                <div class="w-24 h-1 bg-gray-300 rounded mb-6"></div>
            </div>
            <div id="featured-products" class="min-h-[200px]"></div>
        </div>
    </div>

    <div id="toastContainer" class="fixed top-5 right-5 z-50 space-y-2"></div>
    <div id="footer"></div>
    <div id="navbar-container"></div>

    <script>
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `px-4 py-2 rounded shadow text-white text-sm animate-fade-in-up ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
            toast.textContent = message;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        async function loadOrderAndReviews() {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get("session_id") || localStorage.getItem("last_session_id");
            if (!sessionId) return;

            localStorage.setItem("last_session_id", sessionId);
            const API_BASE = "https://buy.karrykraze.com";

            try {
                const orderRes = await fetch(`${API_BASE}/api/get-order?session_id=${sessionId}`);
                const order = await orderRes.json();

                const reviewRes = await fetch("https://api.jsonbin.io/v3/b/6842b73d8561e97a50204314/latest");
                const reviews = (await reviewRes.json()).record.reviews;

                renderOrderItems(order, reviews);
                renderTotals(order);
            } catch (err) {
                console.error("Error:", err);
                showToast("Failed to load order info.", "error");
            }
        }

        function renderOrderItems(data, reviews) {
            const itemsContainer = document.getElementById("orderItems");
            itemsContainer.innerHTML = "";
            let subtotal = 0;

            data.line_items.forEach(item => {
                const div = document.createElement("div");
                div.className = "flex justify-between items-start border-b pb-4";
                const itemTotal = (item.unit_amount * item.quantity) / 100;
                subtotal += itemTotal;

                const pid = item.metadata?.product_id;
                const slug = item.metadata?.slug || "";
                const productReviews = reviews.filter(r => r.productId === pid);

                let ratingHTML = "";
                if (productReviews.length > 0) {
                    const avg = (
                        productReviews.reduce((sum, r) => sum + Number(r.rating || 0), 0) / productReviews.length
                    ).toFixed(1);
                    ratingHTML = `
                        <p class="text-yellow-600 text-xs mt-1">⭐ ${avg} from ${productReviews.length} review${productReviews.length > 1 ? "s" : ""}</p>
                        <a href="/products/${slug}.html" class="text-xs text-blue-600 underline">View all reviews</a>
                    `;
                }

                div.innerHTML = `
                    <div class="flex items-start gap-3">
                        <img src="${item.image || '/imgs/fallback.png'}" alt="${item.description}" class="w-16 h-16 object-cover rounded border" />
                        <div>
                            <p class="font-medium">${item.description}${item.metadata?.variant ? ` - ${item.metadata.variant}` : ""}</p>
                            <p class="text-gray-500 text-xs">Qty: ${item.quantity}</p>
                            ${ratingHTML}
                        </div>
                    </div>
                    <div class="text-right font-semibold whitespace-nowrap">$${itemTotal.toFixed(2)}</div>
                `;

                itemsContainer.appendChild(div);
            });
        }

        function renderTotals(data) {
            const subtotal = data.line_items.reduce((sum, i) => sum + (i.unit_amount * i.quantity) / 100, 0);
            const shipping = data.shipping?.amount_total ? data.shipping.amount_total / 100 : 0;
            const discount = data.total_details?.amount_discount ? data.total_details.amount_discount / 100 : 0;
            const tax = data.total_details?.amount_tax ? data.total_details.amount_tax / 100 : 0;
            const grandTotal = subtotal + shipping + tax - discount;

            const totalsContainer = document.getElementById("orderTotalContainer");
            totalsContainer.innerHTML = `
                <div class="flex justify-between text-sm py-1">
                    <span class="text-gray-700">Subtotal</span>
                    <span>$${subtotal.toFixed(2)}</span>
                </div>
                <div class="flex justify-between text-sm py-1">
                    <span class="text-gray-700">Shipping</span>
                    <span>$${shipping.toFixed(2)}</span>
                </div>
                <div class="flex justify-between text-sm py-1">
                    <span class="text-gray-700">Tax</span>
                    <span>$${tax.toFixed(2)}</span>
                </div>
                <div class="flex justify-between text-sm py-1">
                    <span class="text-gray-700">Discount</span>
                    <span class="text-green-700">−$${discount.toFixed(2)}</span>
                </div>
                <div class="flex justify-between text-base font-bold border-t pt-2 mt-2">
                    <span>Total Paid</span>
                    <span>$${grandTotal.toFixed(2)}</span>
                </div>
            `;
            totalsContainer.classList.remove("hidden");
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadOrderAndReviews();
            document.addEventListener("DOMContentLoaded", loadFeaturedProducts);
        });
    </script>

    <script src="/js/productinsert.js"></script>
    <script>
        fetch("/products/promotion.json")
            .then(res => res.json())
            .then(promoData => {
                const now = new Date();
                const promo = promoData.promotions?.find(p => {
                    const startOk = !p.startDate || new Date(p.startDate) <= now;
                    const endOk = !p.endDate || new Date(p.endDate) >= now;
                    return p.featured && startOk && endOk;
                });
                if (promo?.category) {
                    const cap = promo.category.charAt(0).toUpperCase() + promo.category.slice(1);
                    const interval = setInterval(() => {
                        const title = document.getElementById("featured-title");
                        if (title) {
                            title.textContent = `🔥 All ${cap} items are on sale!!`;
                            clearInterval(interval);
                        }
                    }, 100);
                }
            });

        includeHTML("navbar-container", "/page_inserts/uni_navbar.html", () => {
            initNavbar();
            const addToCartBtn = document.getElementById("add-to-cart-btn");
            if (addToCartBtn) {
                addToCartBtn.addEventListener("click", () => {
                    const variant = document.getElementById("variantSelector")?.value || null;
                    addToCart(activeProduct, variant);
                });
            }
            includeHTML("footer", "/page_inserts/footer.html");
        });
    </script>
</body>
</html>
