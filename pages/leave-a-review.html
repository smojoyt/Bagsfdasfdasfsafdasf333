<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leave a Review – Karry Kraze</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
</head>
<body class="bg-[#fef1e7] text-gray-800 font-sans p-6">
    <div class="max-w-3xl mx-auto px-4 md:px-8 space-y-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 uppercase underline text-center mb-4">Leave a Review</h1>
        <form id="reviewForm" class="space-y-6">
            <!-- Rating -->
            <div>
                <label class="block font-semibold text-lg mb-1">Rate your experience *</label>
                <div id="starRating" class="flex gap-2 text-3xl cursor-pointer text-gray-400">
                    <span data-star="1">★</span>
                    <span data-star="2">★</span>
                    <span data-star="3">★</span>
                    <span data-star="4">★</span>
                    <span data-star="5">★</span>
                </div>
                <input type="hidden" name="rating" id="ratingInput" required />
            </div>

            <!-- Review Headline -->
            <div>
                <label class="block font-semibold text-lg mb-1">Add a headline *</label>
                <input name="reviewHeadline" placeholder="Summarize your experience" required class="w-full p-2 border rounded" />
            </div>

            <!-- Review Text -->
            <div>
                <label class="block font-semibold text-lg mb-1">Write a review *</label>
                <textarea name="reviewText" rows="5" placeholder="Tell us what you like or dislike" required class="w-full p-2 border rounded"></textarea>
            </div>

            <!-- Name and Email -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block font-semibold mb-1">Your name *</label>
                    <input name="name" required class="w-full p-2 border rounded" />
                </div>
                <div>
                    <label class="block font-semibold mb-1">Your email address *</label>
                    <input name="email" type="email" required class="w-full p-2 border rounded" />
                    <p class="text-xs text-gray-500 mt-1">We'll use this to verify your review came from you.</p>
                </div>
            </div>

            <!-- Image Upload -->
            <div>
                <label class="block font-semibold text-lg mb-1">Add media</label>
                <label class="flex items-center justify-center px-4 py-2 bg-white border rounded shadow cursor-pointer w-fit">
                    <span class="mr-2">⬆</span> Upload
                    <input type="file" name="image" accept="image/*" class="hidden" />
                </label>
                <p class="text-xs text-gray-500 mt-1">Upload 1 photo (max 2 MB)</p>
                <img id="previewImage" class="w-full max-w-md mt-4 rounded-xl shadow hidden" alt="Preview" />
            </div>

            <!-- Consent -->
            <label class="inline-flex items-center">
                <input type="checkbox" required class="mr-2" />
                I consent to this review being publicly shown on the site.
            </label>

            <!-- Submit Button -->
            <button type="submit" class="bg-black text-white py-2 px-6 rounded hover:bg-gray-800">Submit Review</button>
        </form>


        <p id="formStatus" class="text-sm mt-2"></p>
    </div>

    <script>
        // Firebase config

        const firebaseConfig = {
            apiKey: "AIzaSyBBDruyZmtNMl2-zJrYwaqUjIHniSolsdk",
            authDomain: "karrykraze-refiews.firebaseapp.com",
            projectId: "karrykraze-refiews",
            storageBucket: "karrykraze-refiews.firebasestorage.app",
            messagingSenderId: "207129112203",
            appId: "1:207129112203:web:910e834e7c1bbe9158ae8e",
        };
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();

        // Load products.json and build the dropdown
        fetch("../products/products.json")
            .then(res => res.json())
            .then(data => {
                const dropdownToggle = document.getElementById("dropdownToggle");
                const dropdownList = document.getElementById("dropdownList");
                const selectedText = document.getElementById("selectedText");
                const selectedInput = document.getElementById("selectedProduct");

                dropdownToggle.addEventListener("click", () => {
                    dropdownList.classList.toggle("hidden");
                });

                document.addEventListener("click", (e) => {
                    if (!dropdownToggle.contains(e.target) && !dropdownList.contains(e.target)) {
                        dropdownList.classList.add("hidden");
                    }
                });

                Object.entries(data).forEach(([key, p]) => {
                    const item = document.createElement("div");
                    item.className = "flex items-center gap-3 px-4 py-2 hover:bg-gray-100 cursor-pointer rounded-xl bg-white shadow hover:shadow-md ";
                    item.innerHTML = `
      <img src="${p.image}" alt="${p.name}" class="w-10 h-10 object-cover rounded" />
      <div class="flex flex-col w-full">
        <p class="text-sm font-medium">${p.name}</p>
        <p class="text-xs text-gray-400 text-right">${p.product_id}</p>
      </div>
`;

                    item.addEventListener("click", () => {
                        selectedText.textContent = `${p.name} (${p.product_id})`;
                        selectedInput.value = key;
                        dropdownList.classList.add("hidden");
                    });
                    dropdownList.appendChild(item);
                });
            });

        // Star rating handler
        const stars = document.querySelectorAll('#starRating span');
        const ratingInput = document.getElementById('ratingInput');

        stars.forEach(star => {
            star.addEventListener('click', () => {
                const rating = parseInt(star.dataset.star);
                ratingInput.value = rating;
                stars.forEach(s => s.classList.toggle('text-yellow-400', parseInt(s.dataset.star) <= rating));
            });
        });


        // Submit handler
        document.getElementById("reviewForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const file = formData.get("image");
            const preview = document.getElementById("previewImage");
            if (file && file.size > 0) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.classList.remove("hidden");
                };
                reader.readAsDataURL(file);
            }


            let imageUrl = "";
            if (file && file.size > 0) {
                const filename = `${Date.now()}_${file.name}`;
                const ref = storage.ref().child("reviewImages/" + filename);
                await ref.put(file);
                imageUrl = await ref.getDownloadURL();
            }

            const payload = {
                productId: formData.get("product"),
                name: formData.get("name").trim(),
                email: formData.get("email").trim(),
                rating: formData.get("rating"),
                quality: formData.get("quality"),
                reviewText: formData.get("reviewText"),
                healingText: formData.get("healingText"),
                imageUrl: imageUrl,
            };

            const res = await fetch("https://hook.us2.make.com/wxlj4rrp6g3bqlkr3mxmfg6cq626j2qj", {
                method: "POST",
                body: JSON.stringify(payload),
                headers: { "Content-Type": "application/json" }
            });

            if (res.ok) {
                form.reset();
                preview.src = "";
                preview.classList.add("hidden");
                document.getElementById("formStatus").textContent = "Thank you! Your review was submitted.";
            }
        });

    </script>
</body>
</html>
