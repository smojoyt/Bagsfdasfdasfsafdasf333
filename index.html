<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Karry Kraze – Unique Bags & Accessories</title>

    <!-- Favicon -->
    <link rel="icon" href="/imgs/Logo/Short/SL_White_01.png" type="image/png" />

    <!-- Website Description -->
    <meta name="description" content="Shop Karry Kraze for stylish, standout bags and fashion accessories. Free U.S. shipping over $50!" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.karrykraze.com/" />
    <meta property="og:title" content="Karry Kraze – Unique Bags & Accessories - 30% Off All Charms" />
    <meta property="og:description" content="Shop Karry Kraze for stylish, standout bags and fashion accessories. Free U.S. shipping over $50!" />
    <meta property="og:image" content="https://www.karrykraze.com/imgs/Promo/30Charms/Card.jpg" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Karry Kraze – Unique Bags & Accessories - 30% Off All Charms" />
    <meta name="twitter:description" content="Shop Karry Kraze for stylish, standout bags and fashion accessories. Free U.S. shipping over $50!" />
    <meta name="twitter:image" content="https://www.karrykraze.com/imgs/Promo/30Charms/Card.jpg" />

    <!-- Custom Scrollbar Style -->
    <style>
        #featured-products::-webkit-scrollbar {
            height: 6px;
        }

        #featured-products::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 10px;
        }
        .line-clamp-4 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
        }

    </style>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Flickity Carousel -->
    <link rel="stylesheet" href="https://unpkg.com/flickity@2/dist/flickity.min.css" />
    <script src="https://unpkg.com/flickity@2/dist/flickity.pkgd.min.js"></script>

    <!-- ImagesLoaded (for smoother image handling) -->
    <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>

    <!-- Custom Scripts -->
    <script src="/js/helpers.js"></script>
    <script src="/js/moreItemsCarousel.js"></script>
    <script src="/js/loadProductData.js"></script>
    <script src="/js/uni_navbar.js"></script>
</head>


<body class="text-gray-800 bg-[#ffeddf]">
    <!-- Transparent Navbar Placeholder -->
    <div id="navbar-container"></div>

    <!-- Hero Banner with Video -->
    <div id="promoContainer" class="relative h-[60vh] w-full flex items-center justify-center text-white overflow-hidden"></div>

    <!-- Hero Banner Default Code
        <section class="relative h-[60vh] w-full flex items-center justify-center text-white overflow-hidden">
        <video autoplay muted loop playsinline class="absolute top-0 left-0 w-full h-full object-cover z-0">
            <source src="/imgs/Banner/Banner3_1.mp4" type="video/mp4" />
            Your browser does not support the video tag.
        </video>

        <!-- Bold bottom-left text
    <div class="absolute bottom-6 left-6 z-10 text-left">
        <h1 class="text-4xl md:text-8xl font-extrabold leading-tight text-white drop-shadow-lg">
            NEW FUZZY&<br>RIBBED LINED BEANIES
        </h1>
        <p class="mt-4 text-2xl font-medium text-white drop-shadow">
            $10 Off All Headwear!!
        </p>
        <a href="https://www.karrykraze.com/pages/promo" class="mt-8 inline-block px-6 py-3 bg-white text-black font-semibold rounded-full hover:bg-gray-200">
            Shop Now
        </a>
    </div>
    </section>
    -->
    <!-- Featured Products -->
    <section class="max-w-max mx-auto py-6 md:py-12">
        <div class=" mx-auto flex items-center justify-between mb-4 px-4 md:px-0">
            <h2 id="featured-title" class="text-2xl md:text-4xl font-extrabold text-gray-800 uppercase">Featured Picks</h2>
            <a href="/pages/promo.html" class="shrink-0 font-bold text-base uppercase underline underline-offset-4 decoration-2">Shop all</a>
        </div>
        <div class=" mx-auto flex px-4 md:px-0">
            <div class="w-24 h-1 bg-gray-300 rounded mb-6"></div>
        </div>
        <div id="featured-products" class="flex flex-nowrap gap-2 justify-center px-1"></div>
    </section>

    <!-- Category Feature -->
    <div id="dynamicFeature" class="w-full py-6 md:py-12"></div>

    <!-- Shop By Category -->
    <section class="max-w-max mx-auto py-6 md:py-12">
        <div class="mx-auto flex items-center justify-between mb-4 px-4 md:px-0">
            <h2 class="text-2xl md:text-4xl font-extrabold text-gray-800 uppercase">Shop By Category</h2>
        </div>
        <div class="mx-auto flex px-4 md:px-0">
            <div class="w-24 h-1 bg-gray-300 rounded mb-6"></div>
        </div>

        <div id="category-grid" class="md:mx-auto md:max-w-max flex overflow-x-auto gap-4 px-4 ml-4 scroll-snap-x snap-x snap-mandatory md:grid md:grid-cols-3 md:overflow-visible md:px-0 md:max-h-[9999px]">
            <!-- Category Card 1 -->
            <a href="/products/catalog.html?category=bags" class="mx-auto snap-start flex-shrink-0 w-[70%] sm:w-[60%] md:w-[24rem] text-center">
                <div class="w-full h-[22rem] md:h-[32rem] bg-white rounded-xl overflow-hidden">
                    <img src="imgs/Products/Pouches/0011_HeartBag/CatIMG_01.jpg" alt="Bags" class="rounded-xl shadow hover:shadow-lg w-full h-full object-cover">
                </div>
                <div class="mb-2 mt-2 md:mt-4 lg:mt-8 text-2xl md:text-3xl font-extrabold text-gray-800 uppercase underline">Bags</div>
            </a>
            <!-- Category Card 2 -->
            <a href="/products/catalog.html?category=headwear" class="mx-auto snap-start flex-shrink-0 w-[70%] sm:w-[60%] md:w-[24rem] text-center">
                <div class="w-full h-[22rem] md:h-[32rem] bg-white rounded-xl overflow-hidden">
                    <img src="/imgs/Products/Hats/BunnyEarsRat/CatIMG_01.jpg" alt="Hats" class="rounded-xl shadow hover:shadow-lg w-full h-full object-cover">
                </div>
                <div class="mb-2 mt-2 md:mt-4 lg:mt-8 text-2xl md:text-3xl font-extrabold text-gray-800 uppercase underline">Hats</div>
            </a>
            <!-- Category Card 3 -->
            <a href="/products/catalog.html?category=charms" class="mx-auto snap-start flex-shrink-0 w-[70%] sm:w-[60%] md:w-[24rem] text-center">
                <div class="w-full h-[22rem] md:h-[32rem] bg-white rounded-xl overflow-hidden">
                    <img src="/imgs/Products/Pendants/Cherry/CatIMG_01.jpg" alt="Charms" class="rounded-xl shadow hover:shadow-lg w-full h-full object-cover">
                </div>
                <div class="mb-2 mt-2 md:mt-4 lg:mt-8 text-2xl md:text-3xl font-extrabold text-gray-800 uppercase underline">Charms</div>
            </a>
            <!-- Add more category cards as needed -->
        </div>
    </section>

    <!--Responsive Promo Banner Section-->
    <section class="max-w-[90rem] mx-auto px-4 md:px-0 py-6 md:py-12 grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Block 1 -->
        <div class="relative h-[28rem] md:h-[46rem] rounded-xl overflow-hidden group">
            <img src="/imgs/Products/Pouches/0011_HeartBag/02_04.jpg" alt="Heart Embossed Mini Purse" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
            <div class="absolute inset-0 transition duration-300"></div>
            <div class="absolute bottom-8 left-8 text-white">
                <h3 class="text-2xl md:text-4xl font-extrabold uppercase">Heart Embossed Mini Purse</h3>
                <p class="mt-1 text-sm md:text-base font-semibold">A playful touch of everyday elegance.</p>
                <a href="/products/bags/Bag_MiniHeart.html" class="uppercase mt-8 inline-block bg-white text-black hover:text-white font-bold px-7 py-3 rounded hover:bg-black transition">Shop Now</a>
            </div>
        </div>

        <!-- Block 2 -->
        <div class="relative h-[28rem] md:h-[46rem] rounded-xl overflow-hidden group">
            <img src="/imgs/Products/Pouches/0013_VelvetCherryPuff/VCP_01_03.jpg" alt="Velvet Cherry Puff Purse" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
            <div class="absolute inset-0 transition duration-300"></div>
            <div class="absolute bottom-8 left-8 text-white">
                <h3 class="text-2xl md:text-4xl font-extrabold uppercase">Velvet Cherry Puff Purse</h3>
                <p class="mt-1 text-sm md:text-base font-semibold">Sweet, soft, and made to pop.</p>
                <a href="products/bags/Bag_VelvetCherryPuff.html" class="uppercase mt-8 inline-block bg-white text-black hover:text-white font-bold px-7 py-3 rounded hover:bg-black transition">Shop Now</a>
            </div>
        </div>
    </section>

    <!--Best Sellers-->
    <section class="max-w-[90rem] mx-auto py-6 md:py-12">
        <div class="mx-auto flex items-center justify-between mb-4 px-4 md:px-0">
            <h2 id="bestseller-title" class="text-2xl md:text-4xl font-extrabold text-gray-800 uppercase">Shop Bestsellers</h2>
            <a href="/products/catalog.html?tags=bestseller" class="shrink-0 font-bold text-base uppercase underline underline-offset-4 decoration-2">Shop all</a>
        </div>
        <div class="mx-auto flex px-4 md:px-0">
            <div class="w-24 h-1 bg-gray-300 rounded mb-6"></div>
        </div>
        <div id="bestseller-products" class="pl-4 md:pl-0 carousel">


        </div>
    </section>
    <!-- review section -->
    <section id="reviewSection" class="px-4 py-8 bg-[#fdf7f1]">
        <h2 class="text-3xl font-bold mb-6 text-center">What Our Customers Say</h2>
        <div id="reviewCarousel" class="carousel"></div>
    </section>



    <!-- More To Love -->
    <section class="mt-12 px-4 text-center">
        <div class=" max-w-[90rem] mx-auto flex items-center justify-between mb-4 px-4 md:px-0">
            <h2 class="text-3xl md:text-4xl font-extrabold text-gray-800 uppercase">More to Love</h2>
            <!-- Optional right-side link (remove if not needed) -->
            <!-- <a href="/products/catalog.html" class="text-sm md:text-base font-semibold text-black hover:underline">Shop all</a> -->
        </div>
        <div class=" max-w-[90rem] mx-auto flex px-4 md:px-0">
            <div class="w-24 h-1 bg-gray-300 rounded mb-6"></div>
        </div>

        <div id="pp_moreitems"></div>
    </section>

    <!-- Footer and Cart Container -->
    <div id="footer"></div>

    <!-- JS Scripts -->
    <style>

        /* Hide scrollbar but keep scroll functionality */
        .scrollbar-hide {
            -ms-overflow-style: none; /* IE/Edge */
            scrollbar-width: none; /* Firefox */
        }

            .scrollbar-hide::-webkit-scrollbar {
                display: none; /* Chrome/Safari */
            }
    </style>
    <script>
        function initReviewCarousel() {
            const container = document.getElementById("reviewCarousel");
            if (!container) return;

            const endpoint = "https://api.jsonbin.io/v3/b/6842b73d8561e97a50204314/latest";
            const headers = {
                "X-Master-Key": "$2a$10$J46OeqIxDrySG761m72SB.jzEHkOGTFlf4tblSOMrzdUS81uiqEzm"
            };

            Promise.all([
                fetch(endpoint, { headers }).then(res => res.json()),
                fetch("/products/products.json").then(res => res.json())
            ])
                .then(([reviewData, productData]) => {
                    const reviews = reviewData?.record?.reviews || [];
                    const products = Object.values(productData);

                    container.innerHTML = "";

                    reviews.forEach(r => {
                        const product = products.find(p => p.product_id === r.productId);
                        const productName = product?.name || r.productName || "";
                        const productImg = product?.image || r.imageUrl || "";
                        const productUrl = product?.url || "#";
                        const reviewText = r.reviewText || "No comment";
                        const isLong = reviewText.length > 300;
                        const shortText = isLong ? reviewText.slice(0, 250).trim() + "..." : reviewText;

                        const rating = +r.rating || 0;
                        const stars = "★".repeat(rating) + "☆".repeat(5 - rating);

                        const cell = document.createElement("div");
                        cell.className = "carousel-cell w-[380px] h-[360px] bg-white rounded-xl shadow-md p-5 m-2 flex flex-col justify-between text-left border border-gray-200";

                        cell.innerHTML = `
  <div class="flex items-center justify-between text-sm text-gray-500 mb-1">
  <div class="flex items-center gap-1">
    <strong class="text-xl text-gray-900">${formatShortName(r.name || "Anonymous")}</strong>
    <span class="flex items-center gap-1 text-blue-700 font-medium text-sm">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-700" fill="currentColor" viewBox="0 0 24 24">
    <path d="M12 0C5.373 0 0 5.373 0 12c0 4.27 2.37 8.01 5.875 10.015L6 24l1.984-1.017C9.312 23.65 10.64 24 12 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm5.293 9.293l-6 6a1 1 0 01-1.414 0l-3-3a1 1 0 011.414-1.414L11 13.586l5.293-5.293a1 1 0 011.414 1.414z"/>
  </svg>
  Verified Buyer
</span>
  </div>
  <span>${r.timestamp ? new Date(r.timestamp).toLocaleDateString() : "Invalid Date"}</span>
</div>


  <div class="text-yellow-500 text-4xl leading-[1.1] mb-1 -mt-2">${stars}</div>

  <h3 class="text-lg font-bold text-gray-800 uppercase">${r.reviewHeadline || ""}</h3>

  <div class="flex-1 overflow-hidden relative mb-3">
    <p class="review-text text-sm text-gray-700 break-words line-clamp-4 overflow-hidden pr-1 h-full" data-full="${reviewText.replace(/"/g, '&quot;')}">
      ${shortText} ${isLong ? `<button class="read-more text-blue-600 hover:underline ml-1 text-sm">Read more</button>` : ""}
    </p>
  </div>

  <div class="pt-4 border-t border-gray-200 shrink-0">
    ${productImg && productName ? `
      <a href="${productUrl}" class="flex items-center gap-2 group">
        <img src="${productImg}" class="w-10 h-10 object-cover rounded" alt="${productName}" onerror="this.style.display='none'">
        <span class="text-sm font-medium text-gray-800 group-hover:underline">${productName}</span>
      </a>` : ""}
  </div>
`;


                        container.appendChild(cell);
                    });

                    // ✅ Attach "Read more" buttons AFTER all reviews are rendered
                    container.querySelectorAll(".read-more").forEach(btn => {
                        btn.addEventListener("click", function () {
                            const p = this.closest(".review-text");
                            const fullText = p.getAttribute("data-full");

                            p.innerText = fullText;
                            p.classList.remove("line-clamp-4", "overflow-hidden");
                            p.classList.add("overflow-y-auto", "pr-1");
                            p.style.maxHeight = "100%";

                            this.remove();
                        });
                    });





                    imagesLoaded(container, () => {
                        const flickity = new Flickity(container, {
                            cellAlign: "left",
                            contain: true,
                            groupCells: 1,
                            autoPlay: 3000,
                            wrapAround: true,
                            pageDots: false,
                            prevNextButtons: false,
                            pauseAutoPlayOnHover: true
                        });
                        flickity.resize();
                    });
                })
                .catch(err => {
                    container.innerHTML = `<div class="text-red-500 text-center">Failed to load reviews.</div>`;
                    console.error("Review load error:", err);
                });
        }



        document.addEventListener("DOMContentLoaded", () => {
            fetch("/products/promotion.json")
                .then(res => res.json())
                .then(data => {
                    const now = new Date();
                    const promotions = data.promotions || [];

                    const activePromo = promotions.find(p => {
                        const now = new Date();
                        const startOk = !p.startDate || new Date(p.startDate) <= now;
                        const endOk = !p.endDate || new Date(p.endDate) >= now;
                        return p.featured && startOk && endOk;
                    }) || promotions.find(p => p.featured);

                    if (!activePromo || !activePromo.media) return;

                    const container = document.getElementById("promoContainer");
                    if (!container) return;

                    const { video, image, headline, caption, button } = activePromo.media;

                    const background = video
                        ? `<video autoplay muted loop playsinline class="absolute top-0 left-0 w-full h-full object-cover z-0">
                        <source src="${video}" type="video/mp4" />
                        Your browser does not support the video tag.
                   </video>`
                        : `<img src="${image}" class="absolute top-0 left-0 w-full h-full object-cover z-0" alt="Promo Background" />`;

                    const buttonHTML = button
                        ? `<a href="${button.url}" class="mt-8 inline-block px-6 py-3 bg-white text-black font-semibold rounded-full hover:bg-gray-200">
                        ${button.label}
                   </a>`
                        : "";

                    container.innerHTML = `
                <section class="relative h-[60vh] w-full flex items-center justify-center text-white overflow-hidden">
                    ${background}
                    <div class="absolute bottom-6 left-6 z-10 text-left">
                        <h1 class="text-4xl md:text-8xl font-extrabold leading-tight text-white drop-shadow-lg">
                            ${headline}
                        </h1>
                        <p class="mt-4 text-2xl font-medium text-white drop-shadow">
                            ${caption}
                        </p>
                        ${buttonHTML}
                        
                    </div>
                </section>
            `;

                    // ✅ Countdown logic placed here
                    // Append countdown banner below promoContainer
                    if (activePromo?.endDate) {
                        const countdownSection = document.createElement("section");
                        countdownSection.className = "w-full bg-yellow-100 text-center py-4 text-lg font-semibold text-gray-900 shadow-md";

                        countdownSection.innerHTML = `<div id="promoCountdown">Loading countdown...</div>`;

                        container.insertAdjacentElement("afterend", countdownSection);

                        const countdownEl = countdownSection.querySelector("#promoCountdown");
                        const endTime = new Date(activePromo.endDate).getTime();

                        function updateCountdown() {
                            const now = new Date().getTime();
                            const timeLeft = endTime - now;

                            if (timeLeft <= 0) {
                                countdownEl.textContent = "⏰ This promo has ended.";
                                clearInterval(timer);
                                return;
                            }

                            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                            const hours = Math.floor((timeLeft / (1000 * 60 * 60)) % 24);
                            const minutes = Math.floor((timeLeft / (1000 * 60)) % 60);
                            const seconds = Math.floor((timeLeft / 1000) % 60);

                            if (days >= 1) {
                                countdownEl.textContent = `⏳ Ends Soon: ${days}d ${hours}h ${minutes}m`;
                            } else {
                                countdownEl.textContent = `⚠️ Final Hours: ${hours}h ${minutes}m ${seconds}s`;
                            }
                        }

                        updateCountdown();
                        const timer = setInterval(updateCountdown, 1000);
                    }




        // ─────────────────────────────────────────────────────
        // UTILITIES
        // ─────────────────────────────────────────────────────

        function includeHTML(id, filePath, callback = null) {
            const target = document.getElementById(id);
            if (!target) return;

            fetch(filePath)
                .then(res => res.text())
                .then(html => {
                    target.innerHTML = html;
                    if (typeof callback === "function") callback();
                })
                .catch(err => {
                    console.error(`❌ Failed to load ${filePath}:`, err);
                });
        }

        function initFooterScripts() {
            const form = document.getElementById("newsletterForm");
            const emailInput = document.getElementById("newsletterEmail");
            const overlay = document.getElementById("thankYouOverlay");

            if (!form || !emailInput) {
                console.warn("❌ Newsletter form not found");
                return;
            }

            form.addEventListener("submit", function (e) {
                e.preventDefault();
                console.log("✅ Newsletter form submitted");

                const email = emailInput.value.trim();
                if (!email.includes("@")) {
                    alert("Please enter a valid email.");
                    return;
                }

                const formData = new FormData();
                formData.append("data[Email]", email);
                formData.append("data[Source]", "Newsletter");

                fetch("https://sheetdb.io/api/v1/33jcww5tw8pyg?sheet=Newsletter_Signups", {
                    method: "POST",
                    body: formData
                })
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to submit to SheetDB");
                        overlay.classList.remove("hidden");
                        form.reset();
                    })
                    .catch(err => {
                        console.error("❌ SheetDB error:", err);
                        alert("Something went wrong.");
                    });
            });

            window.closeThankYou = function () {
                overlay.classList.add("hidden");
            };
        }

        function swapImage(newSrc) {
            const mainImage = document.getElementById("mainImage");
            if (!mainImage) return;
            mainImage.classList.add("opacity-0");
            setTimeout(() => {
                mainImage.src = newSrc;
                mainImage.onload = () => mainImage.classList.remove("opacity-0");
            }, 150);
        }

        function updateVariant(input) {
            const value = typeof input === 'string' ? input : input.value;
            const variantInput = document.getElementById("variantSelector");
            if (variantInput) variantInput.value = value.trim();
        }

        function toggleAccordion() {
            const content = document.getElementById("accordion-content");
            const icon = document.getElementById("accordion-icon");
            if (!content || !icon) return;

            const isOpen = content.style.height && content.style.height !== "0px";
            content.style.height = isOpen ? "0px" : content.scrollHeight + "px";
            icon.classList.toggle("rotate-45", !isOpen);
        }

        // ─────────────────────────────────────────────────────
        // NAVBAR + SCROLL LOGIC
        // ─────────────────────────────────────────────────────

        function initNavbar() {
            const toggleBtn = document.getElementById("mobile-menu-button");
            const menu = document.getElementById("mobile-menu");

            if (toggleBtn && menu) {
                toggleBtn.addEventListener("click", () => {
                    menu.classList.toggle("hidden");
                    updateNavbarStyles?.();
                });
            }

            const cart = JSON.parse(localStorage.getItem("savedCart")) || [];
            const totalQty = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
            const countElem = document.getElementById("cart-count");
            if (countElem) countElem.textContent = totalQty;


        }

        function setupScrollNavbarColorChange() {
            const navbar = document.getElementById("mainNavbar");
            const logo = document.getElementById("logo");
            const burger = document.getElementById("mobile-menu-button");
            const menu = document.getElementById("mobile-menu");
            const mail = document.getElementById("mail-icon");

            let wasScrolled = false;

            window.updateNavbarStyles = function () {
                const isScrolled = window.scrollY > 10;
                const menuOpen = menu && !menu.classList.contains("hidden");
                const shouldBeScrolled = isScrolled || menuOpen;

                if (!navbar || shouldBeScrolled === wasScrolled) return;
                wasScrolled = shouldBeScrolled;



                if (shouldBeScrolled) {
                    navbar.classList.remove("bg-transparent", "text-white");
                    navbar.classList.add("bg-white", "text-black", "shadow-md");
                    burger?.classList.replace("text-white", "text-black");
                    if (mail) mail.classList.replace("text-white", "text-black");
                    if (logo) logo.src = "/imgs/Logo/Long/LL_Black_02.png";
                } else {
                    navbar.classList.remove("bg-white", "text-black", "shadow-md");
                    navbar.classList.add("bg-transparent", "text-white");
                    burger?.classList.replace("text-black", "text-white");
                    if (mail) mail.classList.replace("text-black", "text-white");
                    if (logo) logo.src = "/imgs/Logo/Long/LL_White_02.png";
                }

            };

            updateNavbarStyles();
            window.addEventListener("scroll", updateNavbarStyles);
        }

        // ─────────────────────────────────────────────────────
        // CAROUSEL + FEATURED ITEMS
        // ─────────────────────────────────────────────────────

        function initMoreItemsCarousel() {
            const carouselWrapper = document.querySelector('#pp_moreitems .carousel');
            if (!carouselWrapper) return;

            Promise.all([
                fetch("/products/products.json").then(res => res.json()),
                fetch("/products/promotion.json").then(res => res.json())
            ]).then(([products, promotionFile]) => {
                const promotions = promotionFile.promotions || [];
                const updatedProducts = applyPromotionsToProducts(products, promotions);
                const productKeys = Object.keys(updatedProducts).sort(() => 0.5 - Math.random());

                productKeys.forEach(sku => {
                    const product = updatedProducts[sku];
                    if (!product || !product.image) return;

                    const cell = document.createElement("div");
                    cell.className = "carousel-cell p-2";

                    // ✅ Filter in-stock variants only
                    const variantStock = product.variantStock || {};
                    const inStockColors = Object.keys(variantStock).filter(variant => variantStock[variant] > 0);
                    const swatchString = inStockColors.join("|");

                    cell.innerHTML = `
<a href="/products/${product.category}/${sku}" class="block text-gray-800 hover:text-black">
                                                      <div class="max-w-2xl relative overflow-hidden rounded-lg group md:hover:scale-105 transition">
                                                        <img class="w-full object-contain rounded-t-lg transition md:group-hover:opacity-0" src="${product.image}" alt="${product.name}">
                                                        ${product.thumbnails?.[1] ? `
                                                          <img class="w-full object-contain absolute top-0 left-0 opacity-0 transition md:group-hover:opacity-100"
                                                               src="${product.thumbnails[1]}" alt="Hover image">` : ''}

                                                        ${inStockColors.length > 1 ? `
                                                          <div class="absolute bottom-1 left-1 flex gap-[3px] z-10">
                                                            ${renderColorDots(swatchString, product.variantStock).replaceAll('w-6', 'w-4').replaceAll('h-6', 'h-4')}
                                                          </div>` : ""}
                                                      </div>

                                                      <div class="text-center mt-6">
                                                        <div class="text-sm font-semibold truncate">${product.name}</div>
                                                        ${product.sale_price && product.sale_price < product.price ? `
                                                          <div class="text-sm">
                                                            <span class="text-green-700 font-semibold">$${product.sale_price.toFixed(2)}</span>
                                                            <span class="text-gray-500 line-through ml-2">$${product.price.toFixed(2)}</span>
                                                          </div>` : `
                                                          <div class="text-sm text-gray-600">$${product.price.toFixed(2)}</div>`}
                                                      </div>
</a>
`;

                    carouselWrapper.appendChild(cell);
                });

                imagesLoaded(carouselWrapper, () => {
                    const flickity = new Flickity(carouselWrapper, {
                        cellAlign: "left",
                        contain: true,
                        groupCells: 1,
                        freeScroll: false,
                        wrapAround: false,
                        prevNextButtons: false,
                        pageDots: false,
                        dragThreshold: 5,
                        autoPlay: 3000,
                        pauseAutoPlayOnHover: true
                    });
                    flickity.resize();
                });
            });
        }



        function loadFeaturedProducts() {
            Promise.all([
                fetch("/products/products.json").then(res => res.json()),
                fetch("/products/promotion.json").then(res => res.json())
            ]).then(([products, promotionFile]) => {
                const container = document.getElementById("featured-products");
                if (!container) return;

                const now = new Date();
                const promotions = promotionFile.promotions || [];

                const featuredPromo = promotions.find(p => {
                    const startOk = !p.startDate || new Date(p.startDate) <= now;
                    const endOk = !p.endDate || new Date(p.endDate) >= now;
                    return p.featured && startOk && endOk;
                }) || promotions.find(p => p.featured);

                if (!featuredPromo || !featuredPromo.category) return;

                const targetCategory = featuredPromo.category;

                const filteredProducts = Object.values(products)
                    .filter(p => {
                        if (p.category !== targetCategory) return false;
                        const stock = p.variantStock || {};
                        return Object.values(stock).some(qty => qty > 0);
                    })
                    .sort(() => 0.5 - Math.random())
                    .slice(0, 6); // Max 6 for swiping

                // Responsive column classes
                const colClasses = {
                    1: "md:grid-cols-1",
                    2: "md:grid-cols-2",
                    3: "md:grid-cols-3",
                    4: "md:grid-cols-4",
                    5: "md:grid-cols-5"
                };
                const gridCols = colClasses[Math.min(filteredProducts.length, 5)];

                // Apply updated class
                container.innerHTML = "";
                container.className = `flex overflow-x-auto gap-4 px-4 ml-4 scroll-snap-x snap-x snap-mandatory md:ml-0 md:grid ${gridCols} md:overflow-visible md:px-0 md:max-h-[9999px]`;

                // Update heading if available
                const title = document.getElementById("featured-title");
                if (title) {
                    const cap = targetCategory.charAt(0).toUpperCase() + targetCategory.slice(1);
                    title.textContent = `All New ${cap}`;
                }

                // Render cards
                filteredProducts.forEach(p => {
                    const stock = p.variantStock || {};
                    const inStockColors = Object.keys(stock).filter(variant => stock[variant] > 0);
                    const swatchString = inStockColors.join("|");
                    const secondThumbnail = p.thumbnails?.[1] || p.image;

                    const originalPrice = p.price;
                    let salePrice = originalPrice;
                    if (featuredPromo.type === "percent") {
                        salePrice = originalPrice * (1 - featuredPromo.amount / 100);
                    } else if (featuredPromo.type === "fixed") {
                        salePrice = Math.max(0, originalPrice - featuredPromo.amount);
                    }

                    const wrapper = document.createElement("div");
                    wrapper.className = "mx-auto snap-start flex-shrink-0 w-[48%] sm:w-[45%] md:w-auto max-w-xs md:[&:nth-child(n+6)]:hidden";

                    const card = document.createElement("a");
                    card.href = p.url;
                    card.className = "block overflow-hidden transition";

                    card.innerHTML = `
                <div class="relative w-full bg-white rounded-xl">
                    <img src="${secondThumbnail}" alt="${p.name}" class="shadow hover:shadow-lg w-full object-contain rounded-xl">
                    ${inStockColors.length > 1 ? `
                        <div class="absolute bottom-2 left-2 flex gap-1">
                            ${renderColorDots(swatchString, p.variantStock)}
                        </div>` : ""}
                </div>
                <div class="mt-4 text-left">
                    <div class="text-base sm:text-lg md:text-xl font-bold text-gray-800 leading-snug break-words">${p.name}</div>
                    <div class="mt-1 text-lg font-bold text-green-700">
                        $${salePrice.toFixed(2)}
                        <span class="ml-2 text-gray-500 line-through text-base">$${originalPrice.toFixed(2)}</span>
                    </div>
                </div>
            `;

                    wrapper.appendChild(card);
                    container.appendChild(wrapper);
                });
            });
        }




        function loadDynamicFeatureSection(category) {
            fetch("/products/products.json")
                .then(res => res.json())
                .then(products => {
                    const container = document.getElementById("dynamicFeature");
                    if (!container) return;

                    const matching = Object.values(products)
                        .filter(p => p.category === category && Object.values(p.variantStock || {}).some(qty => qty > 0));

                    if (matching.length === 0) return;
                    const categoryTextMap = {
                        headwear: "Hats",
                        bagaccessory: "Charms",
                        bags: "Bags"
                    };

                    const displayCategory = categoryTextMap[category.toLowerCase()] || category;

                    const selected = matching[Math.floor(Math.random() * matching.length)];
                    const secondThumb = selected.thumbnails?.[1] || selected.image;
                    const name = selected.name;
                    const categoryName = displayCategory;

                    // Dynamic caption options
                    const leftCaptions = [
                        `Each ${name} from our ${categoryName} collection is crafted to express your individuality. Whether you're styling up or keeping it chill, our ${categoryName} are built to turn heads and tell your story.`,
                        `Our ${categoryName} — especially the ${name} — add a bold touch to any outfit. Designed to stand out, styled to be remembered.`,
                        `Make room in your rotation — the ${name} from our ${categoryName} lineup is all about bold statements and everyday ease.`,
                        `Our ${categoryName} were made to do more than just look good — the ${name} proves it every time you wear it.`,
                        `From detail to durability, the ${name} represents everything our ${categoryName} stand for: quality, confidence, and culture.`
                    ];

                    const rightCaptions = [
                        `No matter the moment, our ${categoryName} — like the ${name} — are made to move with you. Effortlessly versatile, endlessly bold, and always unapologetically you.`,
                        `Our ${categoryName} are built for real life. The ${name} keeps up whether you're out all day or just vibing inside.`,
                        `Comfort, style, and practicality — that’s what the ${name} delivers. It’s why our ${categoryName} stay in demand.`,
                        `The ${name} is part of our mission to make ${categoryName} that actually fit your life — and your energy.`,
                        `Why settle for less? Our ${categoryName}, like the ${name}, are made with intention — built to last, styled to flex.`
                    ];

                    const leftText = leftCaptions[Math.floor(Math.random() * leftCaptions.length)];
                    const rightText = rightCaptions[Math.floor(Math.random() * rightCaptions.length)];

                    container.innerHTML = `
<div class="w-full grid grid-cols-1 md:grid-cols-2 items-stretch gap-0">
                                    <!-- Left: Text + Captions -->
                                    <div class="p-10 lg:px-28 lg:py-36 flex flex-col justify-center items-center px-4 sm:px-6 space-y-6 text-center bg-[#fedcc1]">
                                        <h2 class="text-4xl md:text-7xl font-extrabold text-gray-800 uppercase">Home of the ${name}</h2>

                                        <div class="grid grid-cols-2 gap-6">
                                            <!-- Left Caption -->
                                            <div class="space-y-2">
                                                <div class="w-36 h-24 md:h-36 mx-auto flex items-center justify-center">
                                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 md:w-24 md:h-24 text-gray-800" stroke="currentColor">
                                    <path d="M13 8.92226L7.92226 3.84453C6.79623 2.71849 4.97056 2.71849 3.84453 3.84453C2.71849 4.97056 2.71849 6.79623 3.84453 7.92226L16.0777 20.1555C17.2038 21.2815 19.0294 21.2815 20.1555 20.1555C21.2815 19.0294 21.2815 17.2038 20.1555 16.0777L17.0777 13" stroke-width="1.5" stroke-linecap="round"/>
                                    <path d="M6 10L10 6" stroke-width="1.5" stroke-linecap="round"/>
                                    <path d="M16.1 2.30719C16.261 1.8976 16.8385 1.8976 16.9994 2.30719L17.4298 3.40247C17.479 3.52752 17.5776 3.62651 17.7022 3.67583L18.7934 4.1078C19.2015 4.26934 19.2015 4.849 18.7934 5.01054L17.7022 5.44252C17.5776 5.49184 17.479 5.59082 17.4298 5.71587L16.9995 6.81115C16.8385 7.22074 16.261 7.22074 16.1 6.81116L15.6697 5.71587C15.6205 5.59082 15.5219 5.49184 15.3973 5.44252L14.3061 5.01054C13.898 4.849 13.898 4.26934 14.3061 4.1078L15.3973 3.67583C15.5219 3.62651 15.6205 3.52752 15.6697 3.40247L16.1 2.30719Z" />
                                    <path d="M19.9672 9.12945C20.1281 8.71987 20.7057 8.71987 20.8666 9.12945L21.0235 9.5288C21.0727 9.65385 21.1713 9.75284 21.2959 9.80215L21.6937 9.95965C22.1018 10.1212 22.1018 10.7009 21.6937 10.8624L21.2959 11.0199C21.1713 11.0692 21.0727 11.1682 21.0235 11.2932L20.8666 11.6926C20.7057 12.1022 20.1281 12.1022 19.9672 11.6926L19.8103 11.2932C19.7611 11.1682 19.6625 11.0692 19.5379 11.0199L19.14 10.8624C18.732 10.7009 18.732 10.1212 19.14 9.95965L19.5379 9.80215C19.6625 9.75284 19.7611 9.65385 19.8103 9.5288L19.9672 9.12945Z" />
                                    <path d="M5.1332 15.3072C5.29414 14.8976 5.87167 14.8976 6.03261 15.3072L6.18953 15.7065C6.23867 15.8316 6.33729 15.9306 6.46188 15.9799L6.85975 16.1374C7.26783 16.2989 7.26783 16.8786 6.85975 17.0401L6.46188 17.1976C6.33729 17.2469 6.23867 17.3459 6.18953 17.471L6.03261 17.8703C5.87167 18.2799 5.29414 18.2799 5.1332 17.8703L4.97628 17.471C4.92714 17.3459 4.82852 17.2469 4.70393 17.1976L4.30606 17.0401C3.89798 16.8786 3.89798 16.2989 4.30606 16.1374L4.70393 15.9799C4.82852 15.9306 4.92714 15.8316 4.97628 15.7065L5.1332 15.3072Z" />
                                  </svg>
                                                </div>
                                                <p class="text-base md:text-[1.25rem] font-semibold text-gray-800">${leftText}</p>
                                            </div>

                                            <!-- Right Caption -->
                                            <div class="space-y-2">
                                                <div class="w-36 h-24 md:h-36 mx-auto flex items-center justify-center">
                                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 md:w-24 md:h-24" stroke="currentColor">
                                    <path d="M2.92992 12.7732C2.3588 14.4238 2.07325 15.2491 2.43835 15.7587C2.80345 16.2683 3.57742 16.1248 5.12535 15.8376L5.52582 15.7634C5.9657 15.6818 6.18563 15.641 6.39316 15.7012C6.60069 15.7614 6.77232 15.9157 7.11558 16.2245L7.42809 16.5056C8.63602 17.5922 9.79155 17.8917 9.79155 17.8917C10.3431 17.648 10.477 16.7787 10.7447 15.0401L10.814 14.5903C10.8901 14.0962 10.9281 13.8492 11.0475 13.6446C11.1669 13.4399 11.3541 13.3008 11.7286 13.0226L12.0695 12.7693C13.3871 11.7902 14.0459 11.3006 14.0217 10.6404C13.9975 9.98014 13.3063 9.58645 11.9238 8.79907L11.5662 8.59536C11.1733 8.37161 10.9769 8.25974 10.8431 8.07305C10.7094 7.88637 10.6535 7.646 10.5416 7.16529L10.4398 6.72764C10.0462 5.03598 9.84944 4.19015 9.28291 4.02582C8.71638 3.86148 8.1553 4.48747 7.03315 5.73945L6.74284 6.06335C6.42396 6.41912 6.26452 6.59701 6.06247 6.68628C5.86042 6.77556 5.63864 6.76613 5.19508 6.74725L4.79126 6.73007C3.23035 6.66365 2.4499 6.63044 2.12399 7.18912C1.79807 7.7478 2.14254 8.52837 2.83147 10.0895" stroke-width="1.5" stroke-linecap="round"></path>
                                    <path d="M11.9239 8.79864L15 9.65061M9.7916 17.8913L13.0651 18.8409M11.0476 13.6441L19.0252 15.9583M9.28296 4.02539L17.2606 6.33953C17.8271 6.50387 18.0239 7.34969 18.4175 9.04135L18.5193 9.479C18.6312 9.95972 18.6871 10.2001 18.8208 10.3868C18.9546 10.5734 19.151 10.6853 19.5438 10.9091M19.5438 10.9091L19.9015 11.1128C21.284 11.9002 21.9752 12.2939 21.9994 12.9541C22.0236 13.6143 21.3648 14.1039 20.0471 15.083L19.7062 15.3363C19.3318 15.6145 19.1446 15.7536 19.0252 15.9583M19.5438 10.9091L17.6388 10.3815M19.0252 15.9583C18.9058 16.1629 18.8678 16.4099 18.7917 16.904L18.7224 17.3538C18.6408 17.8835 18.5205 18.3551 18.3926 18.7549C18.1952 19.3717 18.0965 19.6801 17.7378 19.8862C17.379 20.0922 17.0322 19.9916 16.3385 19.7904" stroke-width="1.5" stroke-linecap="round"></path>
                                  </svg>
                                                </div>
                                                <p class="text-base md:text-[1.25rem] font-semibold text-gray-800">${rightText}</p>
                                            </div>
                                        </div>
                                        <!-- Buy Now Button -->
<div>
                                  <a href="${selected.url}" class="inline-block mt-4 px-6 py-3 bg-black text-white text-lg font-semibold rounded-full shadow hover:bg-gray-800 transition">
                                    Buy Now
                                  </a>
</div>
                                    </div>

                                    <!-- Right: Full-Bleed Image -->
                                    <div class="w-full h-[400px] sm:h-[600px] md:h-[1100px]">
                                    <img src="${secondThumb}" alt="${name}" class="w-full h-full object-cover object-center">
</div>
</div>`;
                });
        }

        function loadBestsellerProducts() {
            fetch("/products/products.json")
                .then(res => res.json())
                .then(products => {
                    const container = document.getElementById("bestseller-products");
                    if (!container) return;

                    container.innerHTML = "";
                    container.className = "carousel"; // Flickity expects this class

                    const filteredProducts = Object.values(products)
                        .filter(p => p.tags?.includes("Bestseller") && Object.values(p.variantStock || {}).some(qty => qty > 0))
                        .slice(0, 6);

                    filteredProducts.forEach(p => {
                        const stock = p.variantStock || {};
                        const secondThumbnail = p.thumbnails?.[1] || p.image;
                        const inStockColors = Object.keys(stock).filter(variant => stock[variant] > 0);
                        const swatchString = inStockColors.join("|");

                        const originalPrice = p.price;
                        const salePrice = p.sale_price || originalPrice;

                        const wrapper = document.createElement("div");
                        wrapper.className = "pr-3 carousel-cell w-[75%] sm:w-[55%] md:w-[22rem]";

                        const card = document.createElement("a");
                        card.href = p.url;
                        card.className = `block overflow-hidden transition`;

                        card.innerHTML = `
<div class="relative w-full bg-white rounded-xl">
            <img src="${secondThumbnail}" alt="${p.name}" class="shadow hover:shadow-lg w-full object-contain rounded-xl">
            ${inStockColors.length > 1 ? `
                <div class="absolute bottom-2 left-2 flex gap-1">
                    ${renderColorDots(swatchString, p.variantStock)}
                </div>` : ""}
</div>
<div class="mt-4 text-left">
            <div class="text-base sm:text-lg md:text-xl font-bold text-gray-800 leading-snug break-words">${p.name}</div>
            <div class="mt-1 text-lg font-bold text-green-700">
                $${salePrice.toFixed(2)}
                ${salePrice < originalPrice ? `<span class="ml-2 text-gray-500 line-through text-base">$${originalPrice.toFixed(2)}</span>` : ""}
            </div>
</div>
`;

                        wrapper.appendChild(card);
                        container.appendChild(wrapper);
                    });

                    // ✅ Only run Flickity after items are appended
                    imagesLoaded(container, () => {
                        const flickity = new Flickity(container, {
                            cellAlign: 'left',
                            contain: true,
                            groupCells: 1,
                            freeScroll: true,
                            wrapAround: false,
                            prevNextButtons: false,
                            pageDots: false,
                            dragThreshold: 5
                        });
                        flickity.resize();
                    });
                });
        }








        function setupStripeBuyButton() {
            const btn = document.getElementById("buyButton");
            if (!btn) return;

            btn.addEventListener("click", async () => {
                try {
                    const resProducts = await fetch("/products/products.json");
                    const products = await resProducts.json();
                    const product = products[skuFromURL];
                    if (!product) return alert("Product not found.");

                    const variant = document.getElementById("variantSelector")?.value;

                    const res = await fetch("https://buy.karrykraze.com/api/create-checkout-session", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ sku: skuFromURL, selectedVariant: variant })
                    });

                    const data = await res.json();
                    if (data.url) {
                        window.location.href = data.url;
                    } else {
                        alert("Checkout session failed.");
                    }
                } catch (err) {
                    console.error(err);
                    alert("Something went wrong with Stripe checkout.");
                }
            });
        }

        const skuFromURL = window.location.pathname.split("/").pop().replace(".html", "");
        let activeProduct = null;

        document.addEventListener("DOMContentLoaded", () => {
            loadBestsellerProducts();
            loadDynamicFeatureSection("charms"); // or "charms", "headwear", "bags" etc.
            includeHTML("navbar-container", "/page_inserts/uni_navbart.html", () => {
                initNavbar();
                setupScrollNavbarColorChange();
            });

            includeHTML("footer", "/page_inserts/footer.html", initFooterScripts);
            includeHTML("pp_moreitems", "/page_inserts/productpage_moreitems.html", initMoreItemsCarousel);
            loadFeaturedProducts();
            // ✅ ADD THIS
            initReviewCarousel();
            includeHTML("productpage", "/page_inserts/productpage.html", () => {
                loadProductData();
                setupStripeBuyButton();

                const addToCartBtn = document.getElementById("add-to-cart-btn");
                if (addToCartBtn) {
                    addToCartBtn.addEventListener("click", () => {
                        const variant = document.getElementById("variantSelector")?.value || null;
                        addToCart(activeProduct, variant);
                    });
                }
            });

            includeHTML("productpage_shipandret", "/page_inserts/productpage_shipandret.html");
        });
    </script>






</body>
</html>
